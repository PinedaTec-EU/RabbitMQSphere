@page "/"
@inject ArticleService ArticleService
@inject IStringLocalizer<Shared> Localizer
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@using landingpage.portal.Components.Shared
@rendermode InteractiveServer
@using System.Globalization

<PageTitle>PinedaTec - @Localizer["Home"]</PageTitle>

<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="d-flex align-items-center justify-content-center mb-3">
            <div class="logo-container me-3">
                <i class="fas fa-brain fa-3x" style="color: var(--pineda-orange);"></i>
            </div>
            <div>
                <h1 class="mb-0">@Localizer["WelcomeTitle"]</h1>
            </div>
        </div>
        <p class="text-center">@Localizer["WelcomeSubtitle"]</p>
    </div>
</section>

<!-- Terminal Animation -->
<TerminalAnimation />

<!-- Articles Section -->
<section class="container mb-5" id="articles-section">
    <h2 class="text-center mb-4">@Localizer["LatestArticles"]</h2>
    
    @if (isLoading && !loadedArticles.Any())
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (loadedArticles.Any())
    {
        <div class="row g-4">
            @foreach (var article in loadedArticles)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card card-pineda h-100">
                        @if (!string.IsNullOrEmpty(article.Image))
                        {
                            <div class="card-img-wrapper">
                                <img src="@article.Image" class="card-img-top" alt="@GetArticleTitle(article)" 
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%25%22 height=%22200%22%3E%3Crect width=%22100%25%22 height=%22100%25%22 fill=%22%231a1a2e%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2216%22 fill=%22%23ff6f00%22%3EArticle Image%3C/text%3E%3C/svg%3E';">
                            </div>
                        }
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@GetArticleTitle(article)</h5>
                            <p class="text-muted small">
                                <i class="far fa-calendar me-1"></i>
                                @Localizer["PublishedOn"] @article.PublishedDate.ToString("MMM dd, yyyy")
                            </p>
                            <p class="card-text flex-grow-1">@GetArticleExcerpt(article)</p>
                            <a href="@article.Url" target="_blank" class="btn btn-primary btn-sm mt-auto" rel="noopener noreferrer">
                                @Localizer["ReadMore"] <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Load Previous Button -->
        @if (hasMoreArticles)
        {
            <div class="text-center mt-4">
                <button class="btn btn-secondary btn-lg" @onclick="LoadPreviousArticles" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <i class="fas fa-arrow-up me-2"></i>
                    }
                    @Localizer["LoadPrevious"]
                </button>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info text-center">
            No articles available.
        </div>
    }
</section>

@code {
    private List<Article> loadedArticles = new();
    private int currentPage = 1;
    private int pageSize = 6;
    private bool isLoading = true;
    private bool hasMoreArticles = true;
    private string currentLanguage = "en-US";

    protected override async Task OnInitializedAsync()
    {
        // Get page size from configuration
        pageSize = Configuration.GetValue<int>("ArticleSettings:InitialPageSize", 6);
        
        // Detect current language from culture
        var culture = CultureInfo.CurrentCulture.Name;
        currentLanguage = culture.StartsWith("es") ? "es-ES" : "en-US";
        
        await LoadArticles();
    }

    private async Task LoadArticles()
    {
        isLoading = true;
        var result = await ArticleService.GetArticlesAsync(currentPage, pageSize);
        
        if (result != null && result.Items.Any())
        {
            loadedArticles.AddRange(result.Items);
            hasMoreArticles = result.HasNextPage;
        }
        else
        {
            hasMoreArticles = false;
        }
        
        isLoading = false;
    }

    private async Task LoadPreviousArticles()
    {
        if (!hasMoreArticles || isLoading)
            return;

        currentPage++;
        await LoadArticles();
        
        // Scroll to top of articles section to keep header visible
        await JSRuntime.InvokeVoidAsync("scrollToElement", "articles-section");
    }

    private string GetArticleTitle(Article article)
    {
        return article.GetTitle(currentLanguage);
    }

    private string GetArticleExcerpt(Article article)
    {
        return article.GetExcerpt(currentLanguage);
    }
}

<script>
    window.scrollToElement = function(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
</script>

<style>
    .logo-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-img-wrapper {
        position: relative;
        width: 100%;
        height: 200px;
        overflow: hidden;
        background-color: var(--pineda-darker);
    }

    .card-img-top {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .hero-section h1 {
        font-size: 2.5rem;
    }

    @@media (max-width: 768px) {
        .hero-section h1 {
            font-size: 2rem;
        }
        
        .logo-container i {
            font-size: 2rem !important;
        }
    }
</style>
